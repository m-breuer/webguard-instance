services:
  php:
    build:
      context: .
      target: development
      args:
        - USER_ID=${USER_ID:-1000}
        - GROUP_ID=${GROUP_ID:-1000}
    volumes:
      - ./:/var/www/html # Mount local code for development
    environment:
      APP_ENV: local
      AUTORUN_DEBUG: "true"

  # Override for local queue handling: only one worker for all queues
  queue-default:
    command: null # Disable default queue worker

  queue-monitoring-response:
    command: null # Disable monitoring-response queue worker

  queue-monitoring-ssl:
    command: null # Disable monitoring-ssl queue worker

  queue-local:
    build:
      context: .
      target: worker
    deploy:
      replicas: 1 # Ensure only one local queue handler
    environment:
      PHP_MEMORY_LIMIT: "2048M"
      PHP_UPLOAD_MAX_FILE_SIZE: "100M"
      PHP_MAX_EXECUTION_TIME: "3600"
      AUTORUN_ENABLED: "false" # Ensure it runs the command directly
    command: php artisan queue:work --queue=default,monitoring-response,monitoring-ssl --sleep=1 --tries=1 --max-time=3600
    stop_signal: SIGTERM
    env_file:
      - .env
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "healthcheck-queue"]
      start_period: 10s
